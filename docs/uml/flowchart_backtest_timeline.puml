@startuml backtest_timeline
skinparam linetype ortho

title Backtest Day Timeline - Correct Event Sequence

|#LightBlue| Market Time |
|#LightGreen| Backtest Engine (Open Phase) |
|#LightGray| Backtest Engine (Close Phase) |

|Market Time|
:T Day 09:30 - Open;

|Backtest Engine (Open Phase)|
#LightGreen:get_signal_snapshot(T);
note right
  **RESTRICTED SignalSnapshot**
  Contains ONLY:
  - T-day open, pre_settle
  - T-day index open
  - T-1 day complete data
  
  **FORBIDDEN**:
  - T-day close, settle, volume, oi
  - T-day index close
end note

#LightGreen:strategy.on_bar(signal_snapshot, account);
note right
  Strategy generates targets
  using ONLY restricted data
end note

#LightGreen:account.rebalance_to_target(targets, signal_snapshot);
note right
  Execute trades @ open price
  Record trades with realized_pnl
end note

|Market Time|
:T Day 15:00 - Close;
:Settle price announced;

|Backtest Engine (Close Phase)|
#LightGray:get_full_snapshot(T);
note right
  **Full MarketSnapshot**
  All fields now available
  including settle
end note

#LightGray:account.mark_to_market(full_snapshot);
note right
  Daily Settlement:
  PnL = (settle(T) - settle(T-1)) * volume
  cash += daily_pnl
end note

#LightGray:account.record_nav(T);
note right
  NAV = equity / initial_capital
  (valued at settle price)
end note

|Market Time|
:T+1 Day;

@enduml
