@startuml sequence_backtest
skinparam linetype ortho
skinparam sequenceMessageAlign center

title Backtest Engine - Main Loop Sequence Diagram\n(Correct Timeline: Open -> Trade -> Settle)

participant "main.py" as Main
participant "BacktestEngine" as Engine
participant "DataHandler" as DataHandler
participant "Strategy" as Strategy
participant "Account" as Account
participant "SignalSnapshot" as SigSnap #LightGreen
participant "MarketSnapshot" as FullSnap #LightGray

== Initialization ==
Main -> Engine: create(data_handler, strategy, config)
activate Engine
Engine -> Account: create(initial_capital, margin_rate, execution_price_field)
activate Account

== Backtest Loop (for each trading day) ==
Main -> Engine: run(start_date, end_date)

loop for each trade_date in calendar
    Engine -> Engine: _process_day(trade_date)
    
    note over Engine
        ============ T Day 09:30 OPEN ============
    end note
    
    group #LightGreen Get RESTRICTED Signal Snapshot
        Engine -> DataHandler: get_signal_snapshot(trade_date)
        activate DataHandler
        DataHandler -> SigSnap: create(open, pre_settle, T-1 data)
        note right of SigSnap
            FORBIDDEN:
            - T-day close/settle
            - T-day volume/oi
            - T-day index close
        end note
        DataHandler --> Engine: signal_snapshot
        deactivate DataHandler
    end
    
    group #LightGreen Strategy Signal (uses RESTRICTED data only)
        Engine -> Strategy: on_bar(signal_snapshot, account)
        activate Strategy
        Strategy -> SigSnap: get_futures_price('open')
        Strategy -> SigSnap: get_basis() [uses open prices]
        Strategy -> Strategy: calculate targets
        Strategy --> Engine: target_positions
        deactivate Strategy
    end
    
    group #LightGreen Execute Trades @ Open Price
        Engine -> Account: rebalance_to_target(targets, signal_snapshot)
        Account -> SigSnap: get_futures_price('open')
        Account -> Account: execute trades, record with PnL
        Account --> Engine: total_commission
    end
    
    note over Engine
        ============ T Day 15:00 CLOSE ============
        (settle price now known)
    end note
    
    group #LightGray Get Full Snapshot for Settlement
        Engine -> DataHandler: get_snapshot(trade_date)
        activate DataHandler
        DataHandler -> FullSnap: create(all fields including settle)
        DataHandler --> Engine: full_snapshot
        deactivate DataHandler
    end
    
    group #LightGray Mark-to-Market (Daily Settlement)
        Engine -> Account: mark_to_market(full_snapshot)
        Account -> Account: PnL = (settle(T) - settle(T-1)) * volume
        Account -> Account: cash += daily_pnl
        Account --> Engine: daily_pnl
    end
    
    group #LightGray Record NAV
        Engine -> Account: record_nav(trade_date)
        Account -> Account: nav_history[date] = equity / initial_capital
    end
end

== Generate Results ==
Engine -> Engine: build Analyzer
Engine --> Main: BacktestResult
deactivate Account
deactivate Engine

@enduml
